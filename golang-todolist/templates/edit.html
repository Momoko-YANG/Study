<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ç¼–è¾‘ä»»åŠ¡">
    
    <!-- PWA ç›¸å…³ -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#667eea">
    
    <title>ç¼–è¾‘ä»»åŠ¡ - {{.Title}}</title>
    
    <!-- æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1>âœï¸ ç¼–è¾‘ä»»åŠ¡</h1>
            <p>ä¿®æ”¹ä»»åŠ¡ä¿¡æ¯</p>
            
            <!-- å¯¼èˆª -->
            <nav class="nav">
                <a href="/todos/{{.ID}}">â† è¿”å›è¯¦æƒ…</a>
                <a href="/todos">ä»»åŠ¡åˆ—è¡¨</a>
            </nav>
        </header>

        <!-- ç¼–è¾‘è¡¨å• -->
        <div class="card">
            <form id="editForm" method="POST" action="/todos/{{.ID}}/edit" data-todo-id="{{.ID}}">
                <div class="form-group">
                    <label for="title">ä»»åŠ¡æ ‡é¢˜ *</label>
                    <input 
                        type="text" 
                        id="title" 
                        name="title" 
                        class="form-control" 
                        value="{{.Title}}" 
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜"
                        required
                        maxlength="100"
                    >
                    <small style="color: #a0aec0; font-size: 0.9rem;">æœ€å¤š100ä¸ªå­—ç¬¦</small>
                </div>

                <div class="form-group">
                    <label for="description">ä»»åŠ¡æè¿°</label>
                    <textarea 
                        id="description" 
                        name="description" 
                        class="form-control" 
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"
                        rows="4"
                        maxlength="500"
                    >{{.Description}}</textarea>
                    <small style="color: #a0aec0; font-size: 0.9rem;">æœ€å¤š500ä¸ªå­—ç¬¦</small>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input 
                            type="checkbox" 
                            id="completed" 
                            name="completed" 
                            class="todo-checkbox"
                            {{if .Completed}}checked{{end}}
                        >
                        <label for="completed">æ ‡è®°ä¸ºå·²å®Œæˆ</label>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary">
                        ğŸ’¾ ä¿å­˜æ›´æ”¹
                    </button>
                    
                    <a href="/todos/{{.ID}}" class="btn btn-secondary">
                        âŒ å–æ¶ˆ
                    </a>
                    
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </form>
        </div>

        <!-- ä»»åŠ¡é¢„è§ˆ -->
        <div class="card">
            <h3>é¢„è§ˆ</h3>
            <div id="taskPreview" style="background: rgba(102, 126, 234, 0.05); padding: 20px; border-radius: 10px; border-left: 4px solid #667eea;">
                <div id="previewTitle" style="font-size: 1.2rem; font-weight: 600; color: #2d3748; margin-bottom: 8px;">
                    {{.Title}}
                </div>
                <div id="previewDescription" style="color: #718096; margin-bottom: 15px; line-height: 1.5;">
                    {{if .Description}}{{.Description}}{{else}}<em style="color: #a0aec0;">æš‚æ— æè¿°</em>{{end}}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="previewStatus" class="status-badge {{if .Completed}}status-completed{{else}}status-pending{{end}}">
                        {{if .Completed}}âœ… å·²å®Œæˆ{{else}}â³ è¿›è¡Œä¸­{{end}}
                    </span>
                    <span style="color: #a0aec0; font-size: 0.9rem;">
                        æœ€åæ›´æ–°: {{.UpdatedAt.Format "2006-01-02 15:04"}}
                    </span>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œ -->
        <div class="card">
            <h3>å¿«é€Ÿæ“ä½œ</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                <button onclick="duplicateTask()" class="btn btn-secondary">
                    ğŸ“‹ å¤åˆ¶ä»»åŠ¡
                </button>
                
                <button onclick="clearDescription()" class="btn btn-secondary">
                    ğŸ—‘ï¸ æ¸…ç©ºæè¿°
                </button>
                
                <button onclick="toggleComplete()" class="btn {{if .Completed}}btn-secondary{{else}}btn-success{{end}}">
                    {{if .Completed}}â³ æ ‡è®°ä¸ºè¿›è¡Œä¸­{{else}}âœ… æ ‡è®°ä¸ºå®Œæˆ{{end}}
                </button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <div class="loading"></div>
    </div>

    <!-- åŸå§‹æ•°æ®ï¼ˆä»¥ JSON å½¢å¼åµŒå…¥ï¼Œé¿å…å†…è” JS è§£æé—®é¢˜ï¼‰ -->
    <script id="originalDataJSON" type="application/json">{"title": {{printf "%q" .Title}}, "description": {{printf "%q" .Description}}, "completed": {{.Completed}}}</script>

    <!-- JavaScript -->
    <script src="/static/js/app.js"></script>
    
    <!-- é¡µé¢ç‰¹å®šè„šæœ¬ -->
    <script>
        // åŸå§‹æ•°æ®
        const originalData = JSON.parse(document.getElementById('originalDataJSON').textContent);

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ç¼–è¾‘ä»»åŠ¡é¡µé¢å·²åŠ è½½');
            
            // ç»‘å®šè¾“å…¥äº‹ä»¶æ¥æ›´æ–°é¢„è§ˆ
            const titleInput = document.getElementById('title');
            const descriptionInput = document.getElementById('description');
            const completedCheckbox = document.getElementById('completed');
            
            titleInput.addEventListener('input', updatePreview);
            descriptionInput.addEventListener('input', updatePreview);
            completedCheckbox.addEventListener('change', updatePreview);
            
            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + S: ä¿å­˜
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    document.getElementById('editForm').submit();
                }
                
                // Ctrl/Cmd + Z: é‡ç½®
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                    e.preventDefault();
                    resetForm();
                }
                
                // Escape: å–æ¶ˆ
                if (e.key === 'Escape') {
                    if (confirm('ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
                        window.location.href = '/todos/{{.ID}}';
                    }
                }
            });
            
            // è¡¨å•éªŒè¯
            const form = document.getElementById('editForm');
            form.addEventListener('submit', function(e) {
                const title = titleInput.value.trim();
                if (!title) {
                    e.preventDefault();
                    showAlert('è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜', 'error');
                    titleInput.focus();
                    return;
                }
                
                if (title.length > 100) {
                    e.preventDefault();
                    showAlert('ä»»åŠ¡æ ‡é¢˜ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦', 'error');
                    titleInput.focus();
                    return;
                }
                
                const description = descriptionInput.value.trim();
                if (description.length > 500) {
                    e.preventDefault();
                    showAlert('ä»»åŠ¡æè¿°ä¸èƒ½è¶…è¿‡500ä¸ªå­—ç¬¦', 'error');
                    descriptionInput.focus();
                    return;
                }
                
                // æ˜¾ç¤ºä¿å­˜æç¤º
                showAlert('æ­£åœ¨ä¿å­˜...', 'info');
            });
        });

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const completed = document.getElementById('completed').checked;
            
            // æ›´æ–°æ ‡é¢˜
            const previewTitle = document.getElementById('previewTitle');
            previewTitle.textContent = title || 'æœªå‘½åä»»åŠ¡';
            
            // æ›´æ–°æè¿°
            const previewDescription = document.getElementById('previewDescription');
            if (description) {
                previewDescription.textContent = description;
                previewDescription.style.color = '#718096';
            } else {
                previewDescription.innerHTML = '<em style="color: #a0aec0;">æš‚æ— æè¿°</em>';
            }
            
            // æ›´æ–°çŠ¶æ€
            const previewStatus = document.getElementById('previewStatus');
            if (completed) {
                previewStatus.textContent = 'âœ… å·²å®Œæˆ';
                previewStatus.className = 'status-badge status-completed';
            } else {
                previewStatus.textContent = 'â³ è¿›è¡Œä¸­';
                previewStatus.className = 'status-badge status-pending';
            }
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            if (confirm('ç¡®å®šè¦é‡ç½®è¡¨å•å—ï¼Ÿæ‰€æœ‰æ›´æ”¹å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('title').value = originalData.title;
                document.getElementById('description').value = originalData.description;
                document.getElementById('completed').checked = originalData.completed;
                updatePreview();
                showAlert('è¡¨å•å·²é‡ç½®', 'info');
            }
        }

        // å¤åˆ¶ä»»åŠ¡
        function duplicateTask() {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            
            if (!title) {
                showAlert('è¯·å…ˆè¾“å…¥ä»»åŠ¡æ ‡é¢˜', 'error');
                return;
            }
            
            // åˆ›å»ºæ–°ä»»åŠ¡è¡¨å•
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/todos/new';
            
            const titleInput = document.createElement('input');
            titleInput.type = 'hidden';
            titleInput.name = 'title';
            titleInput.value = title + ' (å‰¯æœ¬)';
            
            const descriptionInput = document.createElement('input');
            descriptionInput.type = 'hidden';
            descriptionInput.name = 'description';
            descriptionInput.value = description;
            
            form.appendChild(titleInput);
            form.appendChild(descriptionInput);
            document.body.appendChild(form);
            form.submit();
        }

        // æ¸…ç©ºæè¿°
        function clearDescription() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºä»»åŠ¡æè¿°å—ï¼Ÿ')) {
                document.getElementById('description').value = '';
                updatePreview();
                showAlert('æè¿°å·²æ¸…ç©º', 'info');
            }
        }

        // åˆ‡æ¢å®ŒæˆçŠ¶æ€
        function toggleComplete() {
            const checkbox = document.getElementById('completed');
            checkbox.checked = !checkbox.checked;
            updatePreview();
            showAlert(checkbox.checked ? 'å·²æ ‡è®°ä¸ºå®Œæˆ' : 'å·²æ ‡è®°ä¸ºè¿›è¡Œä¸­', 'info');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '1000';
            alert.style.minWidth = '200px';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // é¡µé¢ç¦»å¼€å‰ç¡®è®¤
        window.addEventListener('beforeunload', function(e) {
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const completed = document.getElementById('completed').checked;
            
            const hasChanges = 
                title !== originalData.title ||
                description !== originalData.description ||
                completed !== originalData.completed;
            
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                return e.returnValue;
            }
        });
    </script>
</body>
</html>
